# This is a Databricks asset bundle definition for databricks_pipelines.
# See https://docs.databricks.com/dev-tools/bundles/index.html for documentation.
bundle:
  name: databricks_asset_bundle # The name of the bundle.
  description: A Databricks asset bundle for lakehouse ETL pipelines
  fail_on_active_runs: true # Fail deployment if there are active runs for existing jobs.
  deployment:
    # concurrent_jobs: 5 # Number of jobs to deploy concurrently. only for large bundles.
    lock:
      enabled: true # Enable deployment locking to prevent concurrent deployments.
      timeout_minutes: 10 # Maximum time to wait for the lock.
        
run_as:
  user_name: ${workspace.current_user.userName} # Run jobs as the current user.
  # service_principal_name: databricks- # Optional: Run jobs as a service principal with this pre

# Include all resource definition files.
include:
  - resources/*.yml
  - resources/*/*.yml

# sync: # Files to sync to the Databricks workspace. from the local filesystem.
#   include:
#     - ../src/my_etl_1/** 

# artifacts:
#   # Define artifacts to be deployed with the bundle.
#   # See https://docs.databricks.com/dev-tools/bundles/artifacts.html for documentation.
#   - type: library
#     name: my_etl_1_library
#     path: ../src/my_etl_1/dist/my_etl_1-0.1.0-py3-none-any.whl

# python:
#   version: 3.9
#   package_manager: pip
#   dependencies:
#     - pandas==2.0.3
#     - dlt==1.3.0
#     - databricks-sdk==0.16.0
#     - lakefs-dlt==0.9.0
#     - pyarrow==11.0.0
#     - delta-spark==3.4.0
#     - requests==2.31.0
#     - setuptools>=65.5.1
#   venv_path: .venv_databricks_bundle
#   venv_ignore_local_packages: false
#   resources:
#     - resources.python:load_resources
#   mutators:
#     - 'mutators:add_email_notifications'

# Variable declarations. These variables are assigned in the dev/prod targets below.
variables:
  catalog:
    description: The catalog to use
  schema:
    description: The schema to use

targets:
  local:
    # The default target uses 'mode: local' to create a local copy.
    # - Deployed resources get prefixed with '[local my_user_name]'
    # - Any job schedules and triggers are paused by default.
    # See also https://docs.databricks.com/dev-tools/bundles/deployment-modes.html.
    mode: development
    default: true # This is the default target if none is specified.     
    presets:
      name_prefix: "${workspace.current_user.short_name}_"
      auto_pause_schedules: true # Automatically pause schedules on deployment
      auto_pause_triggers: true  # Automatically pause triggers on deployment
      # trigger_pause_status: PAUSED # Set trigger pause status to PAUSED
      # pipelines_development: true # Deploy pipelines in development mode
      # jobs_max_concurrent_runs: 10 # Limit max concurrent runs for jobs     
    workspace:
      host: https://dbc-b1af0c2a-6757.cloud.databricks.com
      root_path: /Workspace/Users/contactmail.br@gmail.com/.bundle/${bundle.name}/${bundle.target}
    variables:
      catalog: catalog
      schema: ${workspace.current_user.short_name}
    # scripts:
    #   post_deployment: # Scripts to run after deployment
    #     - ./scripts/post_deployment/local_setup.sh
    #   post_removal: # Scripts to run after removal
    #     - ./scripts/post_removal/local_cleanup.sh
    permissions:
      - user_name: ${workspace.current_user.userName}
        level: CAN_MANAGE
      - group_name: users
        level: CAN_VIEW
      # - service_principal_name: dbx-sp
      #   level: CAN_RUN
      

  dev:
    # The default target uses 'mode: development' to create a development copy.
    mode: production
    workspace:
      host: https://dbc-b1af0c2a-6757.cloud.databricks.com
      root_path: /Workspace/Users/contactmail.br@gmail.com/.bundle/${bundle.name}/${bundle.target}
    variables:
      catalog: catalog
      schema: development
    permissions:
      - user_name: contactmail.br@gmail.com
        level: CAN_MANAGE
  prod:
    mode: production
    workspace:
      host: https://dbc-b1af0c2a-6757.cloud.databricks.com
      # We explicitly deploy to /Workspace/Users/user@company.com to make sure we only have a single copy.
      root_path: /Workspace/Users/contactmail.br@gmail.com/production/.bundle/${bundle.name}/${bundle.target}
    variables:
      catalog: catalog
      schema: prod
    permissions:
      - user_name: contactmail.br@gmail.com
        level: CAN_VIEW